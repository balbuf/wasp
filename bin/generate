#!/usr/bin/env php
<?php

use OomphInc\WASP\YamlTransformer;

if (!$vendor_dir = getenv('COMPOSER_VENDOR_DIR')) {
	$vendor_dir = 'vendor';
}

foreach ([ "/../$vendor_dir/autoload.php", "/$vendor_dir/autoload.php", '/../../../autoload.php' ] as $path) {
	$path = __DIR__ . $path;
	if (file_exists($path)) {
		require_once $path;
		break;
	}
}

//get input (or env variables)
$theme_root = getenv( 'THEME_ROOT' );
$config_input = getenv( 'CONFIG_INPUT' );
$config_output = getenv( 'CONFIG_OUTPUT' );

$yaml_string = file_get_contents($config_input);

if ($yaml_string === false) {
	echo "Error reading file $config_input\n";
	exit(1);
}

$transformer = new YamlTransformer($yaml_string);

foreach (get_class_methods('OomphInc\\WASP\\BasicHandlers') as $handler) {
	$transformer->add_handler($handler, 'wasp_' . $handler, ['OomphInc\\WASP\\BasicHandlers', $handler]);
}

$compiled = $transformer->execute();
// @todo: lint the file!
//file_put_contents("{$theme_root}/{$config_output}", $compiled);
echo $compiled;
