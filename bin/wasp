#!/usr/bin/env php
<?php

namespace OomphInc\WASP;

use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Logger\ConsoleLogger;
use Symfony\Component\Console\ConsoleEvents;

define('WASP_TYPE', 'wasp-plugin');

// allow an autoloader to be explicitly passed
if ($autoload = getenv('WASP_AUTOLOAD')) {
	$paths = [$autoload];
} else {
	$vendorDir = getenv('WASP_VENDOR_DIR') ?: getenv('COMPOSER_VENDOR_DIR') ?: 'vendor';
	$paths = [__DIR__ . '/../../../autoload.php', __DIR__ . "/../$vendorDir/autoload.php", __DIR__ . "/$vendorDir/autoload.php"];
}

// attempt to find the autoload file for this project
do {
	foreach ($paths as $path) {
		if (file_exists($path)) {
			require_once $path;
			// set the lock file in relation to this
			$lockFile = dirname($path) . '/../composer.lock';
			break 2;
		}
	}
	// if we reach this point, we did not find the autoload file
	echo 'Could not find autoload file';
	exit(1);
} while (0);

$input = new ArgvInput();
$output = new ConsoleOutput();
$errOut = $output->getErrorOutput();
// default to decoration for the logger (can be disabled with --no-ansi)
$errOut->setDecorated(true);
$logger = new ConsoleLogger($errOut);
$application = App::create($input, $output, $logger);

// look for any plugins inside of the lock file
$lockFile = getenv('WASP_LOCK') ?: $lockFile;
// do we have one?
if (file_exists($lockFile)) {
	App::setPlugins($application, file_get_contents($lockFile));
} else {
	$application->services->logger->warning('No lock file located');
}

// add global options
$application->getDefinition()->addOption(
	new InputOption('include', null, InputOption::VALUE_REQUIRED | InputOption::VALUE_IS_ARRAY, 'Additional files to include before executing.')
);
// process global options before running command
$application->services->dispatcher->addListener(ConsoleEvents::COMMAND, function ($event) use ($application) {
	// optional files to include
	foreach ($application->services->input->getOption('include') as $file) {
		if (!is_readable($file)) {
			throw new RuntimeException("File does not exist or is not readable: $file");
		}
		require_once $file;
	}
});

App::run($application);
